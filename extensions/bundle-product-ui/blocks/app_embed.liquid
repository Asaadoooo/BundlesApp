<!-- Bundle App Embed - Injects bundle display below Buy it now button -->
<script>
(function() {
  // Only run on product pages
  if (!window.location.pathname.includes('/products/')) return;

  const productId = {{ product.id | default: 'null' }};
  if (!productId) return;

  // Settings from schema
  const settings = {
    showIndividualPrices: {{ block.settings.show_individual_prices | default: true }},
    showSavingsBadge: {{ block.settings.show_savings_badge | default: true }},
    primaryColor: '{{ block.settings.primary_color | default: "#000000" }}'
  };

  function injectBundleDisplay() {
    // Find the buy button or add to cart form
    const buyButtonSelectors = [
      '.shopify-payment-button',           // Buy it now button container
      'button[name="add"]',                 // Add to cart button
      '.product-form__submit',              // Common submit button class
      '[data-add-to-cart]',                 // Data attribute selector
      '.product-form__buttons',             // Button container
      'form[action="/cart/add"] button[type="submit"]',
      '.product__submit__add',
      '.add-to-cart',
      '#AddToCart'
    ];

    let insertTarget = null;

    for (const selector of buyButtonSelectors) {
      const element = document.querySelector(selector);
      if (element) {
        // Get the parent container for better placement
        insertTarget = element.closest('.product-form__buttons') ||
                       element.closest('.product-form') ||
                       element.parentElement;
        break;
      }
    }

    if (!insertTarget) {
      console.log('[Bundle Embed] Could not find buy button, trying form');
      insertTarget = document.querySelector('form[action="/cart/add"]');
    }

    if (!insertTarget) {
      console.log('[Bundle Embed] No suitable injection point found');
      return;
    }

    // Create bundle container
    const bundleContainer = document.createElement('div');
    bundleContainer.id = 'bundle-embed-display';
    bundleContainer.innerHTML = `
      <div class="bundle-display" data-product-id="${productId}">
        <div class="bundle-loading">
          <p>Loading bundle...</p>
        </div>
        <div class="bundle-content" style="display: none;"></div>
      </div>
    `;

    // Insert after the buy button container
    insertTarget.parentNode.insertBefore(bundleContainer, insertTarget.nextSibling);

    // Load bundle data
    loadBundle();
  }

  async function loadBundle() {
    const bundleDisplay = document.querySelector('#bundle-embed-display .bundle-display');
    if (!bundleDisplay) return;

    try {
      const apiUrl = `/apps/bundles/api/storefront/bundle/by-product/${productId}`;
      console.log('[Bundle Embed] Fetching:', apiUrl);
      const response = await fetch(apiUrl);
      console.log('[Bundle Embed] Response status:', response.status);

      if (!response.ok) {
        if (response.status === 404) {
          // No bundle for this product - hide the container
          console.log('[Bundle Embed] No bundle found (404)');
          bundleDisplay.parentElement.style.display = 'none';
          return;
        }
        const errorText = await response.text();
        console.error('[Bundle Embed] Error response:', errorText);
        throw new Error(`Failed to load bundle: ${response.status}`);
      }

      const data = await response.json();
      console.log('[Bundle Embed] Bundle data:', data);

      if (!data.bundle) {
        console.log('[Bundle Embed] No bundle in response');
        bundleDisplay.parentElement.style.display = 'none';
        return;
      }

      renderBundle(data.bundle, bundleDisplay);
    } catch (error) {
      console.error('[Bundle Embed] Error loading bundle:', error);
      bundleDisplay.querySelector('.bundle-loading').innerHTML =
        `<div class="bundle-error">Failed to load bundle: ${error.message}</div>`;
    }
  }

  function renderBundle(bundle, container) {
    const loadingEl = container.querySelector('.bundle-loading');
    const contentEl = container.querySelector('.bundle-content');

    // API returns: displayPrice, compareAtPrice, savingsAmount, savingsPercent
    // Items have: imageUrl, title, price, variantId, quantity
    const items = bundle.items || [];
    const displayPrice = bundle.displayPrice || 0;
    const compareAtPrice = bundle.compareAtPrice;
    const savingsAmount = bundle.savingsAmount;
    const savingsPercent = bundle.savingsPercent;

    const html = `
      <div class="bundle-header">
        <div class="bundle-title">${escapeHtml(bundle.title)}</div>
        ${bundle.description ? `<div class="bundle-description">${escapeHtml(bundle.description)}</div>` : ''}
      </div>

      ${items.length > 0 ? `
      <div class="bundle-items">
        <strong>What's included:</strong>
        ${items.map(item => `
          <div class="bundle-item">
            ${item.imageUrl ? `
              <img src="${item.imageUrl}" alt="${escapeHtml(item.title || 'Product')}" class="bundle-item-image">
            ` : ''}
            <div class="bundle-item-details">
              <div class="bundle-item-title">${item.quantity}x ${escapeHtml(item.title || 'Product')}</div>
              ${settings.showIndividualPrices && item.price ? `
                <div class="bundle-item-price">€${item.price.toFixed(2)}</div>
              ` : ''}
            </div>
          </div>
        `).join('')}
      </div>
      ` : ''}

      <div class="bundle-pricing">
        <div class="bundle-price-row">
          <span class="bundle-price-label">Bundle Price:</span>
          <div>
            ${compareAtPrice && compareAtPrice > displayPrice ? `
              <span class="bundle-price-compare">€${compareAtPrice.toFixed(2)}</span>
            ` : ''}
            <span class="bundle-price-value">€${displayPrice.toFixed(2)}</span>
          </div>
        </div>

        ${settings.showSavingsBadge && savingsAmount && savingsAmount > 0 ? `
          <div class="bundle-savings-badge">
            You save €${savingsAmount.toFixed(2)} (${savingsPercent ? savingsPercent.toFixed(0) : 0}%)
          </div>
        ` : ''}
      </div>

      <button class="bundle-add-to-cart" data-bundle-id="${bundle.id}">
        Add Bundle to Cart
      </button>
    `;

    contentEl.innerHTML = html;
    contentEl.classList.add('loaded');
    loadingEl.style.display = 'none';

    // Add event listener
    const addButton = contentEl.querySelector('.bundle-add-to-cart');
    addButton.addEventListener('click', () => addBundleToCart(bundle, addButton));
  }

  async function addBundleToCart(bundle, button) {
    button.disabled = true;
    button.textContent = 'Adding to Cart...';

    try {
      // API returns items with: variantId, quantity, title, price
      const cartItems = (bundle.items || []).map(item => {
        // Extract numeric variant ID from GID if needed
        let variantId = item.variantId;
        if (variantId && variantId.includes('gid://')) {
          variantId = variantId.split('/').pop();
        }
        return {
          id: variantId,
          quantity: item.quantity,
          properties: {
            '_bundle_id': bundle.id,
            '_bundle_title': bundle.title,
            '_bundle_savings': bundle.savingsAmount?.toFixed(2) || '0'
          }
        };
      });

      console.log('[Bundle Embed] Adding to cart:', cartItems);

      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: cartItems })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        console.error('[Bundle Embed] Cart error response:', errorData);
        throw new Error(errorData?.description || 'Failed to add to cart');
      }

      window.location.href = '/cart';
    } catch (error) {
      console.error('[Bundle Embed] Cart error:', error);
      button.textContent = 'Add Bundle to Cart';
      button.disabled = false;
      alert(`Failed to add bundle to cart: ${error.message}`);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectBundleDisplay);
  } else {
    injectBundleDisplay();
  }
})();
</script>

<style>
  #bundle-embed-display .bundle-display {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
  }

  #bundle-embed-display .bundle-loading {
    text-align: center;
    padding: 20px;
    color: #666;
  }

  #bundle-embed-display .bundle-content {
    display: none;
  }

  #bundle-embed-display .bundle-content.loaded {
    display: block !important;
  }

  #bundle-embed-display .bundle-header {
    margin-bottom: 16px;
  }

  #bundle-embed-display .bundle-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 8px;
  }

  #bundle-embed-display .bundle-description {
    color: #666;
    margin-bottom: 16px;
  }

  #bundle-embed-display .bundle-items {
    margin: 16px 0;
  }

  #bundle-embed-display .bundle-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: #f9f9f9;
    border-radius: 4px;
  }

  #bundle-embed-display .bundle-item-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 12px;
  }

  #bundle-embed-display .bundle-item-details {
    flex: 1;
  }

  #bundle-embed-display .bundle-item-title {
    font-weight: 500;
    margin-bottom: 4px;
  }

  #bundle-embed-display .bundle-item-price {
    color: #666;
    font-size: 14px;
  }

  #bundle-embed-display .bundle-pricing {
    border-top: 1px solid #e5e5e5;
    padding-top: 16px;
    margin-top: 16px;
  }

  #bundle-embed-display .bundle-price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  #bundle-embed-display .bundle-price-label {
    font-size: 16px;
  }

  #bundle-embed-display .bundle-price-value {
    font-size: 20px;
    font-weight: bold;
  }

  #bundle-embed-display .bundle-price-compare {
    text-decoration: line-through;
    color: #999;
    margin-right: 8px;
  }

  #bundle-embed-display .bundle-savings-badge {
    display: inline-block;
    background: #50b83c;
    color: white;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 14px;
    margin-top: 8px;
  }

  #bundle-embed-display .bundle-add-to-cart {
    width: 100%;
    padding: 14px;
    background: #000;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 16px;
  }

  #bundle-embed-display .bundle-add-to-cart:hover {
    opacity: 0.9;
  }

  #bundle-embed-display .bundle-add-to-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  #bundle-embed-display .bundle-error {
    color: #d72c0d;
    padding: 12px;
    background: #fef1f1;
    border-radius: 4px;
  }
</style>

{% schema %}
{
  "name": "Bundle Display Embed",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_individual_prices",
      "label": "Show individual prices",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_savings_badge",
      "label": "Show savings badge",
      "default": true
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary color",
      "default": "#000000"
    }
  ]
}
{% endschema %}
