{% comment %}
  Bundle Display Block
  Displays bundle information on product pages
{% endcomment %}

<div class="bundle-display" data-product-id="{{ product.id }}">
  <div class="bundle-loading">
    <p>Loading bundle...</p>
  </div>
  <div class="bundle-content" style="display: none;">
    <!-- Bundle content will be injected by JavaScript -->
  </div>
</div>

<style>
  .bundle-display {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
  }

  .bundle-loading {
    text-align: center;
    padding: 20px;
    color: #666;
  }

  .bundle-content {
    display: none;
  }

  .bundle-content.loaded {
    display: block !important;
  }

  .bundle-header {
    margin-bottom: 16px;
  }

  .bundle-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 8px;
    color: {{ block.settings.primary_color }};
  }

  .bundle-description {
    color: #666;
    margin-bottom: 16px;
  }

  .bundle-items {
    margin: 16px 0;
  }

  .bundle-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: #f9f9f9;
    border-radius: 4px;
  }

  .bundle-item-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 12px;
  }

  .bundle-item-details {
    flex: 1;
  }

  .bundle-item-title {
    font-weight: 500;
    margin-bottom: 4px;
  }

  .bundle-item-price {
    color: #666;
    font-size: 14px;
  }

  .bundle-pricing {
    border-top: 1px solid #e5e5e5;
    padding-top: 16px;
    margin-top: 16px;
  }

  .bundle-price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .bundle-price-label {
    font-size: 16px;
  }

  .bundle-price-value {
    font-size: 20px;
    font-weight: bold;
    color: {{ block.settings.primary_color }};
  }

  .bundle-price-compare {
    text-decoration: line-through;
    color: #999;
    margin-right: 8px;
  }

  .bundle-savings-badge {
    display: inline-block;
    background: #50b83c;
    color: white;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 14px;
    margin-top: 8px;
  }

  .bundle-add-to-cart {
    width: 100%;
    padding: 14px;
    background: {{ block.settings.primary_color }};
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 16px;
  }

  .bundle-add-to-cart:hover {
    opacity: 0.9;
  }

  .bundle-add-to-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .bundle-error {
    color: #d72c0d;
    padding: 12px;
    background: #fef1f1;
    border-radius: 4px;
    margin-top: 12px;
  }
</style>

<script>
  (function() {
    // ========== DEBUG CONFIG ==========
    const DEBUG = true; // Set to false to disable debug messages
    const SHOW_DEBUG_PANEL = true; // Set to false to hide on-page debug panel
    // ==================================

    function debugLog(category, message, data = null) {
      if (!DEBUG) return;
      const timestamp = new Date().toISOString().split('T')[1].slice(0, -1);
      const prefix = `[Bundle Block ${timestamp}]`;
      if (data) {
        console.log(`${prefix} [${category}]`, message, data);
      } else {
        console.log(`${prefix} [${category}]`, message);
      }
      updateDebugPanel(category, message, data);
    }

    function updateDebugPanel(category, message, data) {
      if (!SHOW_DEBUG_PANEL) return;
      const panel = document.getElementById('bundle-debug-panel');
      if (panel) {
        const line = document.createElement('div');
        line.innerHTML = `<span style="color:#888">[${category}]</span> ${message}${data ? ': ' + JSON.stringify(data).slice(0, 100) : ''}`;
        panel.appendChild(line);
        panel.scrollTop = panel.scrollHeight;
      }
    }

    debugLog('INIT', 'üéÅ Bundle Display Block initializing...');

    const bundleDisplay = document.querySelector('.bundle-display');
    if (!bundleDisplay) {
      debugLog('ERROR', '‚ùå Bundle display element not found');
      return;
    }

    const productId = bundleDisplay.dataset.productId;
    debugLog('INIT', 'üì¶ Product ID from data attribute', productId);
    debugLog('INIT', 'üìç Page URL', window.location.href);
    debugLog('INIT', 'üè™ Shop domain', window.Shopify?.shop || 'Not available');

    const showIndividualPrices = {{ block.settings.show_individual_prices }};
    const showSavingsBadge = {{ block.settings.show_savings_badge }};
    debugLog('INIT', '‚öôÔ∏è Settings', { showIndividualPrices, showSavingsBadge });

    // Add debug panel to page
    if (SHOW_DEBUG_PANEL) {
      const debugPanel = document.createElement('div');
      debugPanel.id = 'bundle-debug-panel';
      debugPanel.style.cssText = 'background:#1a1a2e;color:#0f0;padding:12px;margin:10px 0;border-radius:8px;font-family:monospace;font-size:11px;max-height:200px;overflow-y:auto;border:2px solid #16213e;';
      debugPanel.innerHTML = '<div style="color:#fff;font-weight:bold;margin-bottom:8px;">üîß Bundle Debug Console</div>';
      bundleDisplay.insertBefore(debugPanel, bundleDisplay.firstChild);
    }

    async function loadBundle() {
      try {
        debugLog('FETCH', 'üîÑ Starting bundle fetch...');

        // Fetch bundle data via App Proxy
        const apiUrl = `/apps/bundles/api/storefront/bundle/by-product/${productId}`;
        debugLog('FETCH', 'üåê API URL', apiUrl);

        const startTime = performance.now();
        const response = await fetch(apiUrl);
        const duration = Math.round(performance.now() - startTime);

        debugLog('FETCH', `üì° Response received in ${duration}ms`, {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: {
            contentType: response.headers.get('content-type'),
            cacheControl: response.headers.get('cache-control')
          }
        });

        if (!response.ok) {
          if (response.status === 404) {
            debugLog('FETCH', '‚ÑπÔ∏è No bundle found for this product (404)');
            const errorBody = await response.json().catch(() => null);
            debugLog('FETCH', 'üìã 404 Response body', errorBody);
            bundleDisplay.style.display = 'none';
            return;
          }
          const errorText = await response.text();
          debugLog('ERROR', `‚ùå HTTP Error ${response.status}`, errorText);
          throw new Error(`Failed to load bundle: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        debugLog('DATA', '‚úÖ Bundle data received', {
          hasBundle: !!data.bundle,
          bundleId: data.bundle?.id,
          bundleTitle: data.bundle?.title,
          bundleType: data.bundle?.type,
          itemCount: data.bundle?.items?.length
        });

        if (!data.bundle) {
          debugLog('ERROR', '‚ö†Ô∏è Response OK but no bundle in data');
          bundleDisplay.style.display = 'none';
          return;
        }

        const bundle = data.bundle;
        debugLog('RENDER', 'üé® Rendering bundle', bundle.title);

        // Render bundle
        renderBundle(bundle);
        debugLog('RENDER', '‚úÖ Bundle rendered successfully');

      } catch (error) {
        debugLog('ERROR', '‚ùå Error loading bundle', { message: error.message, stack: error.stack });
        console.error('Error loading bundle:', error);
        bundleDisplay.querySelector('.bundle-loading').innerHTML =
          `<div class="bundle-error">Failed to load bundle information<br><small style="color:#666">${error.message}</small></div>`;
      }
    }

    function renderBundle(bundle) {
      const loadingEl = bundleDisplay.querySelector('.bundle-loading');
      const contentEl = bundleDisplay.querySelector('.bundle-content');

      let html = `
        <div class="bundle-header">
          <div class="bundle-title">${escapeHtml(bundle.title)}</div>
          ${bundle.description ? `<div class="bundle-description">${escapeHtml(bundle.description)}</div>` : ''}
        </div>

        <div class="bundle-items">
          <strong>What's included:</strong>
          ${bundle.items.map(item => `
            <div class="bundle-item">
              ${item.product?.featuredImage ? `
                <img src="${item.product.featuredImage}" alt="${escapeHtml(item.product.title)}" class="bundle-item-image">
              ` : ''}
              <div class="bundle-item-details">
                <div class="bundle-item-title">${item.quantity}x ${escapeHtml(item.product?.title || 'Product')}</div>
                ${showIndividualPrices && item.product?.variants[0] ? `
                  <div class="bundle-item-price">${item.product.variants[0].price}</div>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>

        <div class="bundle-pricing">
          <div class="bundle-price-row">
            <span class="bundle-price-label">Bundle Price:</span>
            <div>
              ${bundle.totalCompareAtPrice && bundle.totalCompareAtPrice > bundle.totalPrice ? `
                <span class="bundle-price-compare">‚Ç¨${bundle.totalCompareAtPrice.toFixed(2)}</span>
              ` : ''}
              <span class="bundle-price-value">‚Ç¨${bundle.totalPrice.toFixed(2)}</span>
            </div>
          </div>

          ${showSavingsBadge && bundle.savings > 0 ? `
            <div class="bundle-savings-badge">
              You save ‚Ç¨${bundle.savings.toFixed(2)} (${bundle.savingsPercentage.toFixed(0)}%)
            </div>
          ` : ''}
        </div>

        <button class="bundle-add-to-cart" data-bundle-id="${bundle.id}">
          Add Bundle to Cart
        </button>
      `;

      contentEl.innerHTML = html;
      contentEl.classList.add('loaded');
      loadingEl.style.display = 'none';

      // Add event listener to add-to-cart button
      const addButton = contentEl.querySelector('.bundle-add-to-cart');
      addButton.addEventListener('click', () => addBundleToCart(bundle));
    }

    async function addBundleToCart(bundle) {
      debugLog('CART', 'üõí Adding bundle to cart...', { bundleId: bundle.id, title: bundle.title });

      const button = bundleDisplay.querySelector('.bundle-add-to-cart');
      button.disabled = true;
      button.textContent = 'Adding to Cart...';

      try {
        // Add bundle items to cart
        const items = bundle.items.map(item => ({
          id: item.variantId || item.product?.variants?.[0]?.id,
          quantity: item.quantity,
          properties: {
            '_bundle_id': bundle.id,
            '_bundle_title': bundle.title,
            '_bundle_savings': bundle.savings?.toFixed(2) || '0'
          }
        }));

        debugLog('CART', 'üì¶ Cart items prepared', items);

        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items })
        });

        debugLog('CART', 'üì° Cart response', { status: response.status, ok: response.ok });

        if (!response.ok) {
          const errorData = await response.json().catch(() => null);
          debugLog('CART', '‚ùå Cart error response', errorData);
          throw new Error(errorData?.description || 'Failed to add to cart');
        }

        const cartData = await response.json();
        debugLog('CART', '‚úÖ Added to cart successfully', cartData);

        // Redirect to cart
        window.location.href = '/cart';
      } catch (error) {
        debugLog('ERROR', '‚ùå Cart error', { message: error.message });
        console.error('Error adding to cart:', error);
        button.textContent = 'Add Bundle to Cart';
        button.disabled = false;
        alert(`Failed to add bundle to cart: ${error.message}`);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load bundle on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadBundle);
    } else {
      loadBundle();
    }
  })();
</script>

{% schema %}
{
  "name": "Bundle Display",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_individual_prices",
      "label": "Show individual prices",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_savings_badge",
      "label": "Show savings badge",
      "default": true
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary color",
      "default": "#000000"
    }
  ]
}
{% endschema %}
